<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Opal test</title>
		<style type="text/css" media="screen">
			#editor {
				position: absolute;
				top: 0;
				right: 50%;
				bottom: 0;
				left: 0;
				border-right: 1px solid #BBB;
			}
			[id="editor"] {
				color: transparent;
			}

			#stage {
				position: absolute;
				top: 0;
				right: 0;
				bottom: 0;
				left: 50%;
				border-left: 1px solid #DEDEDE;
			}
		</style>
		<link rel="stylesheet" href="css/normalize.css">
		<link rel="stylesheet" href="css/main.css">
		<script src="js/vendor/phaser.js"></script>
		<script src="js/vendor/dat.gui.js"></script>
		<script src="js/vendor/opal.js"></script>
	</head>
	<body>
		<div id="editor">rect 0, 0, 200, 200 do
    fill 'blue'
end

rect 100, 100, 200, 200 do
    stroke 'white', 10
    fill 'green'
end

arc 100, 100, 40, { start: 0, end: 2 * `Math.PI` } do
    stroke 'white', 10
    fill '#DEDEDE'
end</div>
		<div id="stage"></div>
		<script src="js/vendor/ace.js"></script>
		<script src="js/vendor/ace/theme-tomorrow.js"></script>
		<script src="js/vendor/ace/mode-ruby.js"></script>
		<script src="js/sketch.js"></script>
		<script>
			var editor = ace.edit("editor");
			editor.setTheme("ace/theme/tomorrow");
			editor.getSession().setMode("ace/mode/ruby");

			window.compiler = Opal.Opal.Compiler.$new();

			var recompile = function() {
				var source = compiler.source = "Sketch.sketch do\n" + editor.getValue() + "\nend";
				return compiler.$compile();
			}

			var editorEval = function() {
				try {
					editor.getSession().clearAnnotations();
					var compiled = recompile();
					Opal.Sketch.$canvas().$clear();
					eval(compiled);
				} catch (e) {
					generated_location = e.$backtrace()[5].match(/(\d+):(\d+)\)$/);
					generated_line = parseInt(generated_location[1]);
					generated_column = parseInt(generated_location[2]);

					generated_location = compiler.$source_map().$map().mappings.filter(function(m){
						return (m.generated.line == generated_line) && m.generated.column > generated_column
					})[0];

					original_line = generated_location.original.line;

					setTimeout(function() {
						editor.getSession().setAnnotations([{type: 'error', text: e.message, row: original_line - 2}])
					}, 0);
				} finally {
					return true;
				}
			}
			editorEval();

			editor.on('change', function() {
				editorEval();
			});
		</script>
	</body>
</html>