<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Opal test</title>
		<style type="text/css" media="screen">
			#editor {
				position: absolute;
				top: 0;
				right: 50%;
				bottom: 0;
				left: 0;
				border-right: 1px solid #BBB;
			}
			[id="editor"] {
				color: transparent;
			}

			#stage {
				position: absolute;
				top: 0;
				right: 0;
				bottom: 0;
				left: 50%;
				border-left: 1px solid #DEDEDE;
			}
		</style>
		<link rel="stylesheet" href="css/normalize.css">
		<link rel="stylesheet" href="css/main.css">
		<script src="js/vendor/phaser.js"></script>
		<script src="js/vendor/dat.gui.js"></script>
		<script src="js/vendor/opal.js"></script>
	</head>
	<body>
		<div id="editor">rect 0, 0, 200, 200 do
    fill 'blue'
end

rect 100, 100, 200, 200 do
    stroke 'white', 10
    fill 'green'
end

arc 100, 100, 40, { start: 0, end: 2 * `Math.PI` } do
    stroke 'white', 10
    fill '#DEDEDE'
end</div>
		<div id="stage"></div>
		<script src="js/vendor/ace.js"></script>
		<script src="js/vendor/ace/theme-tomorrow.js"></script>
		<script src="js/vendor/ace/mode-ruby.js"></script>
		<script src="js/ruby.js"></script>
		<script>
			var editor = ace.edit("editor");
			editor.setTheme("ace/theme/tomorrow");
			editor.getSession().setMode("ace/mode/ruby");

			var compiler = Opal.Opal.Compiler.$new();

			var recompile = function() {
				var source = "sketch { " + editor.getValue() + " }";
				return compiler.$compile(source);
			}
			eval(recompile());

			editor.on('change', function() {
				try {
					editor.getSession().clearAnnotations();
					var compiled = recompile();
					Opal.Object.$canvas().$clear();
					eval(compiled);
				} catch (e) {
					editor.getSession().setAnnotations([{type: 'error', text: e.message, row: 0}])
				} finally {
					return true;
				}
			});
		</script>
	</body>
</html>